const fs = require("fs");
const path = require("path");
const os = require("os");
const { spawn } = require("child_process");
const { Command } = require("commander");
const { fetch } = require("undici");
const chalk = require("chalk");
const inquirer = require("inquirer");
const { success, log, warn, error, hint, actionRunner, commandDescriptions } = require("../parser");
const { version } = require("../../package.json");

/**
 * Check if the CLI was installed via npm
 */
const isInstalledViaNpm = () => {
    try {
        const scriptPath = process.argv[1];
        
        // Common indicators of npm global installation
        if (scriptPath.includes('node_modules') && scriptPath.includes('appwrite-cli')) {
            return true;
        }
        
        // Check for npm global paths
        if (scriptPath.includes('/usr/local/lib/node_modules/') || 
            scriptPath.includes('/opt/homebrew/lib/node_modules/') ||
            scriptPath.includes('/.npm-global/') ||
            scriptPath.includes('/node_modules/.bin/')) {
            return true;
        }
        
        return false;
    } catch (e) {
        return false;
    }
};

/**
 * Check if the CLI was installed via Homebrew
 */
const isInstalledViaHomebrew = () => {
    try {
        const scriptPath = process.argv[1];
        return scriptPath.includes('/opt/homebrew/') || scriptPath.includes('/usr/local/Cellar/');
    } catch (e) {
        return false;
    }
};

/**
 * Get the latest version from npm registry
 */
const getLatestVersion = async () => {
    try {
        const response = await fetch('https://registry.npmjs.org/{{ language.params.npmPackage|caseDash }}/latest');
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        const data = await response.json();
        return data.version;
    } catch (e) {
        throw new Error(`Failed to fetch latest version: ${e.message}`);
    }
};

/**
 * Compare versions using semantic versioning
 */
const compareVersions = (current, latest) => {
    const currentParts = current.split('.').map(Number);
    const latestParts = latest.split('.').map(Number);
    
    for (let i = 0; i < Math.max(currentParts.length, latestParts.length); i++) {
        const currentPart = currentParts[i] || 0;
        const latestPart = latestParts[i] || 0;
        
        if (latestPart > currentPart) return 1;  // Latest is newer
        if (latestPart < currentPart) return -1; // Current is newer
    }
    
    return 0; // Same version
};

/**
 * Execute command and return promise
 */
const execCommand = (command, args = [], options = {}) => {
    return new Promise((resolve, reject) => {
        const child = spawn(command, args, { 
            stdio: 'inherit',
            shell: true,
            ...options 
        });
        
        child.on('close', (code) => {
            if (code === 0) {
                resolve();
            } else {
                reject(new Error(`Command failed with exit code ${code}`));
            }
        });
        
        child.on('error', (err) => {
            reject(err);
        });
    });
};

/**
 * Update via npm
 */
const updateViaNpm = async () => {
    try {
        await execCommand('npm', ['install', '-g', '{{ language.params.npmPackage|caseDash }}@latest']);
        success("Updated to latest version via npm!");
        hint("Run '{{ language.params.executableName|caseLower }} --version' to verify the new version.");
    } catch (e) {
        // Check if error is due to file already existing (likely already latest version)
        if (e.message.includes('EEXIST') || e.message.includes('file already exists')) {
            success("Latest version is already installed via npm!");
            hint("The CLI is up to date. Run '{{ language.params.executableName|caseLower }} --version' to verify.");
        } else {
            error(`Failed to update via npm: ${e.message}`);
            hint("Try running: npm install -g {{ language.params.npmPackage|caseDash }}@latest --force");
        }
    }
};

/**
 * Update via Homebrew
 */
const updateViaHomebrew = async () => {
    try {
        await execCommand('brew', ['upgrade', '{{ language.params.executableName|caseLower }}']);
        success("Updated to latest version via Homebrew!");
        hint("Run '{{ language.params.executableName|caseLower }} --version' to verify the new version.");
    } catch (e) {
        // Check if error is due to package already being up-to-date
        if (e.message.includes('already installed') || e.message.includes('up-to-date')) {
            success("Latest version is already installed via Homebrew!");
            hint("The CLI is up to date. Run '{{ language.params.executableName|caseLower }} --version' to verify.");
        } else {
            error(`Failed to update via Homebrew: ${e.message}`);
            hint("Try running: brew upgrade {{ language.params.executableName|caseLower }}");
        }
    }
};

/**
 * Update via installation script
 */
const updateViaScript = async () => {
    const platform = os.platform();
    
    try {
        if (platform === 'win32') {
            // Windows PowerShell script
            await execCommand('powershell', ['-Command', 'iwr -useb https://appwrite.io/cli/install.ps1 | iex']);
        } else {
            // Linux/macOS bash script
            await execCommand('sh', ['-c', 'wget -q https://appwrite.io/cli/install.sh -O - | /bin/bash']);
        }
        success("Updated to latest version via installation script!");
        hint("Run '{{ language.params.executableName|caseLower }} --version' to verify the new version.");
    } catch (e) {
        // Check if error indicates already up-to-date
        if (e.message.includes('already exists') || e.message.includes('up-to-date')) {
            success("Latest version is already installed!");
            hint("The CLI is up to date. Run '{{ language.params.executableName|caseLower }} --version' to verify.");
        } else {
            error(`Failed to update via installation script: ${e.message}`);
            if (platform === 'win32') {
                hint("Try running: iwr -useb https://appwrite.io/cli/install.ps1 | iex");
            } else {
                hint("Try running: wget -q https://appwrite.io/cli/install.sh -O - | /bin/bash");
            }
        }
    }
};

/**
 * Show manual update instructions
 */
const showManualInstructions = (latestVersion) => {
    log("Manual update options:");
    console.log("");
    
    log(`${chalk.bold("Option 1: NPM")}`);
    console.log(`  npm install -g {{ language.params.npmPackage|caseDash }}@latest`);
    console.log("");
    
    log(`${chalk.bold("Option 2: Homebrew (macOS)")}`);
    console.log(`  brew upgrade {{ language.params.executableName|caseLower }}`);
    console.log("");
    
    log(`${chalk.bold("Option 3: Installation Script")}`);
    if (os.platform() === 'win32') {
        console.log(`  iwr -useb https://appwrite.io/cli/install.ps1 | iex`);
    } else {
        console.log(`  wget -q https://appwrite.io/cli/install.sh -O - | /bin/bash`);
    }
    console.log("");
    
    log(`${chalk.bold("Option 4: Download Binary")}`);
    console.log(`  Visit: https://github.com/appwrite/sdk-for-cli/releases/tag/${latestVersion}`);
    console.log("");
};

/**
 * Main update function
 */
const updateCli = async ({ manual } = {}) => {
    try {
        const latestVersion = await getLatestVersion();
        
        const comparison = compareVersions(version, latestVersion);
        
        if (comparison === 0) {
            success(`You're already running the latest version (${chalk.bold(version)})!`);
            return;
        } else if (comparison < 0) {
            warn(`You're running a newer version (${chalk.bold(version)}) than the latest released version (${chalk.bold(latestVersion)}).`);
            hint("This might be a pre-release or development version.");
            return;
        }
        
        log(`Updating from ${chalk.blue(version)} to ${chalk.green(latestVersion)}...`);
        console.log("");
        
        if (manual) {
            showManualInstructions(latestVersion);
            return;
        }
        
        // Auto-detect installation method and update automatically
        if (isInstalledViaNpm()) {
            await updateViaNpm();
        } else if (isInstalledViaHomebrew()) {
            await updateViaHomebrew();
        } else {
            // Unknown installation method - try npm first, then show manual instructions
            try {
                await updateViaNpm();
            } catch (e) {
                // If npm failed and it's not because the version is already installed
                if (!e.message.includes('EEXIST') && !e.message.includes('file already exists')) {
                    error("Could not detect installation method or update failed.");
                    showManualInstructions(latestVersion);
                }
                // If it's EEXIST error, updateViaNpm already handled it with success message
            }
        }
        
    } catch (e) {
        error(`Failed to check for updates: ${e.message}`);
        hint("You can manually check for updates at: https://github.com/appwrite/sdk-for-cli/releases");
    }
};

const update = new Command("update")
    .description("Update the {{ spec.title|caseUcfirst }} CLI to the latest version")
    .option("--manual", "Show manual update instructions instead of auto-updating")
    .action(actionRunner(updateCli));

module.exports = {
    update
};